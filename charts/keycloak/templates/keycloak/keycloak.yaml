{{- $keycloakHostname := include "keycloak.hostname" . }}
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
  name: {{ include "keycloak.fullname" . }}
  namespace: {{ include "keycloak.namespace" . }}
spec:
  db:
    database: {{ .Values.keycloak.postgresql }}
    host: {{ include "keycloak.postgresql.fullname" . }}
    passwordSecret:
      key: {{ .Values.postgresql.secret.passwordKey }}
      name: {{ include "keycloak.postgresql.secret.name" . }}
    usernameSecret:
      key: {{ .Values.postgresql.secret.usernameKey }}
      name: {{ include "keycloak.postgresql.secret.name" . }}
    vendor: postgres
  http:
    {{- if .Values.keycloak.tls.enabled }}
    tlsSecret: keycloak-tls
    {{- else }}
    httpEnabled: true
    {{- end }}
  ingress:
    enabled: false
  hostname:
    strict: {{ .Values.keycloak.strictHostname }}
    {{- if $keycloakHostname }}
    hostname: {{ $keycloakHostname }}
    {{- end }}
    strictBackchannel: {{ not .Values.keycloak.tls.enabled }}
  instances: 1
  {{- if .Values.keycloak.resources }}
  unsupported:
    podTemplate:
      spec:
        containers:
          - resources: {{- tpl (toYaml .Values.keycloak.resources) $ | nindent 14 }}
  {{- end }}
